  <!DOCTYPE html>
  <!-- saved from url=(0049)http://datajournalism.ntu.edu.tw/post/89535832028 -->
  <html class="no-js" lang="en"><script src="./index_files/rapid-3.18.1.js"></script><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">




  <script src="./index_files/jquery.min.js"></script>





  <!-- Basic Page Settings -->

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">




  <!-- Li-Yuan Custom -->
  <link rel="stylesheet" href="./index_files/liyuan/tw_map.css">
  <link rel="stylesheet" type="text/css" href="./index_files/liyuan/smallman.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  <script src="./index_files/liyuan/smallman.js"></script>
  <script src="./index_files/liyuan/map.d3.js"></script>
  <script src="./index_files/liyuan/map_revise.js"></script>
  <style>
  #map-canvas img{max-width: inherit;}
  </style>
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
  <script type="text/javascript">
  var googlemap, layer, geocoder;
  function initialize() {
    var taiwan = new google.maps.LatLng(23.973875, 120.982024);
    geocoder = new google.maps.Geocoder();

    googlemap = new google.maps.Map(document.getElementById('map-canvas'), {
      center: taiwan,
      zoom: 8
    });

    layer = new google.maps.FusionTablesLayer({
      query: {
        select: '\'Geocodable address\'',
        from: '1YKMYkHsbLta_rXfGtRrx2N578QYL3hFv1CF8waaF'
      },
      heatmap: {
        enabled: true
      }
    });
    layer.setMap(googlemap);
    google.maps.event.addListener(googlemap, 'zoom_changed', function() {
      var zoomLevel = googlemap.getZoom();

      if( zoomLevel < 8 ) {
        googlemap.setZoom(8);
      }

      if( zoomLevel > 10 ) {
        layer.setOptions({
          styles: [{
            markerOptions: {
              iconName: 'small_yellow'
            }
          }],
          heatmap: {
            enabled: false
          }
        });
      } else {
        layer.setOptions({
          heatmap: {
            enabled: true
          }
        });
      } 
    });
    google.maps.event.addListener(googlemap, 'bounds_changed', function(){
      var bounds = googlemap.getBounds();
      var leftBound = 117.99099616796877;
      var rightBound = 127;
      console.log('bounds:'+bounds.getSouthWest()+','+bounds.getNorthEast());

      if( bounds.getSouthWest().lng() < leftBound ){
        var originSW = bounds.getSouthWest();
        var originNE = bounds.getNorthEast();
        var diff = leftBound - bounds.getSouthWest().lng();
        var newBounds = new google.maps.LatLngBounds(
          new google.maps.LatLng(originSW.lat(), leftBound),
          new google.maps.LatLng(originNE.lat(), originNE.lng()+diff)
        );
        googlemap.setCenter(newBounds.getCenter());
      }
      else if( bounds.getNorthEast().lng() > rightBound ){
        var originSW = bounds.getSouthWest();
        var originNE = bounds.getNorthEast();
        var diff = bounds.getNorthEast().lng() - rightBound;
        var newBounds = new google.maps.LatLngBounds(
          new google.maps.LatLng(originSW.lat(), originSW.lng()-diff),
          new google.maps.LatLng(originNE.lat(), rightBound)
        ); 
        googlemap.setCenter(newBounds.getCenter());
      }
    });


    setTimeout(function(){google.maps.event.trigger(googlemap, 'resize')}, 1500);
  }


  google.maps.event.addDomListener(window, 'load', initialize);
  getLocation();

  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(showPosition);
    } else {
      console.log("Geolocation is not supported by this browser.");
    }
  }

  function showPosition(position) {
    // console.log(position.coords.latitude);
    // console.log(position.coords.longitude);
    // console.log(googlemap);
    googlemap.panTo(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
    googlemap.setZoom(15);
  }

  function codeAddress() {
    var address = document.getElementById('address').value;
    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        googlemap.panTo(results[0].geometry.location);
        googlemap.setZoom(15);
      } else {
        console.log('Geocode was not successful for the following reason: ' + status);
      }
    });
    return false;
  }

  </script>
  <style>
    .banner{
      margin:0px;
      background-color:#CB624F;
      color:white;
      text-align: center;
      padding-top: 30px;
      padding-bottom: 30px;
      font-size:32px;

    }
  </style>
  <!-- Li-Yuan Custom -->

</head>



<body style="padding:0px;border:0px;font-family:Microsoft JhengHei;font-size:18px">
  <div class="container" style="width:100%;margin:0px;padding:0px;border:0px;">
    <div id="smallman-graph" style="border:0px;padding:0px;margin:0px;position:relative;">
      <h2 style="margin-bottom:0px;"class="banner">年底九合一選舉　選舉規模人數為史上最高</h2>
      <h5 style="margin:0px;color:white;text-align:right;margin-top:0px;background-color:#CB624F;"><span style="position:relative;right:10px;bottom:10px;">記者陳貞樺、蔣宜婷、吳旻誠、潘冠綸、洪立遠／報導</span></h5>
      <p style="padding-left:20px;padding-right:20px;padding-bottom:30px;color:white;margin:0px;background-color:#CB624F;margin-bottom:10px;">根據中選會的統計，今年年底的九合一選舉預計選出高達11130名公職人員，為台灣自治史上最高。其中六都預計選出4688人，其他縣市則是6442人。在這一萬多名公職人員中，里長職位最多，為7851人;其次為各行政層級民代表，有2146人。值得一提的是，這次選舉將增加「直轄市山地原住民區民代表」和「區長」投票，預計選出原住民區長6名、以及山地原住民區民代表50名。</p>
    </div>
    <div id="smallman-ratio" style="position:absolute;right:0px;width:90px;height:20px;display:inline-block;">
      <img id="smallman-ratio-1" style="position:absolute;opacity:1.0"class="smallman" data-type="mayor" src="./index_files/liyuan/country-delegate.png" >
      <img id="smallman-ratio-2" style="position:absolute;width:5px;height:5px;top:5px;"src="./index_files/liyuan/ratio.png" >
      <img id="smallman-ratio-3" style="position:absolute;width:5px;height:5px;top:15px;"src="./index_files/liyuan/ratio.png" >
      <img id="smallman-ratio-4" style="position:absolute;opacity:1.0"class="smallman" data-type="mayor" src="./index_files/liyuan/country-delegate.png" >
      <img id="smallman-ratio-5"style="position:absolute;opacity:1.0"class="smallman" data-type="mayor" src="./index_files/liyuan/country-delegate.png" >
      <img id="smallman-ratio-6"style="position:absolute;opacity:1.0"class="smallman" data-type="mayor" src="./index_files/liyuan/country-delegate.png" >
      <img id="smallman-ratio-7" style="position:absolute;opacity:1.0"class="smallman" data-type="mayor" src="./index_files/liyuan/country-delegate.png" >
      <img id="smallman-ratio-8"style="position:absolute;opacity:1.0"class="smallman" data-type="mayor" src="./index_files/liyuan/country-delegate.png" >
      <img id="smallman-ratio-9"style="position:absolute;opacity:1.0"class="smallman" data-type="mayor" src="./index_files/liyuan/country-delegate.png" >
    </div>
    <div id="vote-number-map" style="margin-top:30px;position:relative;margin-left:auto;margin-right:auto;">
      <h2 class="banner">點點看你要領幾張選票</h2>
      <svg id="svg1">
	<div id = "tooltip1" class="map-tooltip">
        <p><span style="font-size:22px"id="name"></span></p>
        <p>應選人數</p>
        <p>縣(市)長：<span id="t1v1"></span></p>
        <p>縣(市)議員：<span id="t1v2"></span></p>
        <p id="p1">鄉(鎮、市)長/原住民區長：<span id="t1v3"></span></p>
        <p id="p2">鄉(鎮、市)民代表/原住民區民代表：<span id="t1v4"></span></p>
        <p>村(里)長：<span id="t1v5"></span></p>
        <p>合計：<span id="t1v6"></span></p>
      </div>
      <div id = "tooltip2" class="map-tooltip">
        <p><span style="font-size:22px"id= "name2"></span></p>
        <p>應選人數</p>
        <p>鄉(鎮、市)長/原住民區長：<span id="t2v1"></span></p>
        <p>鄉(鎮、市)民代表/原住民區民代表：<span id="t2v2"></span></p>
      </div>
	
      <div style="position:absolute;left:80%;top:370px;"id="image_explanation">
        <div id="image_color">
          <div id ="sample1" class = "color_sample"></div>
          五張選票<br>
          <div id ="sample2" class = "color_sample"></div>
          三張選票<br>
          <div id ="sample3" class = "color_sample"></div>
          山地原住民五張選票  
        </div>
      </div>
      </svg>


      <div style="clear:both;"id = "under_map" class="text_area">
        <h2 class="banner">從七合一選舉到九合一選舉 原住民爭取自治</h2>
        <p style="padding-left:20px;padding-right:20px;padding-bottom:30px;color:white;margin:0px;background-color:#CB624F;">山地原住民區在2010年五都改制後，五個原住民鄉鎮包括烏來、和平、那瑪夏、茂林及桃源合併變成直轄市的區，由於直轄市區長為官派，依法不再實施自治。當時新上路的《地方制度法》遂因此受到原住民族與公民團體質疑，認為此舉將違反聯合國及馬英九2008年競選政見對原住民自治權的承諾。最後在當地原住民爭取下，立院於今（2014）年1月三讀通過，直轄市下轄區由山地鄉改制者，改稱「山地原住民區」，恢復區長、區代表選舉，並享相關地方自治權限。</p>
        <p style="padding-left:20px;padding-right:20px;padding-bottom:30px;color:white;margin:0px;background-color:#CB624F;">而經過立法院三讀通過公職人員選舉罷免法修正案後，增列「直轄市山地原住民區民代表」及「直轄市山地原住民區長」兩個地方公職人員。年底地方選舉也才從七合一選舉，變成了九合一選舉。</p>
        <p style="padding-left:20px;padding-right:20px;padding-bottom:30px;color:white;margin:0px;background-color:#CB624F;">依103年5月28日修正公布之公職人員選舉罷免法第2條規定，地方公職人員選舉包括直轄市長、直轄市議員、縣(市)長、縣(市)議員、鄉(鎮、市)長、鄉(鎮、市)民代表、直轄市山地原住民區長、直轄市山地原住民區民代表及村(里)長選舉等9種。</p>
      </div>
    </div>
    <script type="text/javascript">
        //Width and height
        var w = $("div.container").width();
        var h = 550;
        var islands = ['澎湖縣','金門縣','連江縣','綠島鄉','蘭嶼鄉','琉球鄉'];
        var tooltip_top = h-180;
        var map_right_top = h-180-200;
        var color_top = h-180;
        var color_five = "#FA8722";
        var color_three = "#E2244A";
        var color_native = "#BB009A";
        d3.select("#tooltip1")
        .style("z-index","3")
        .style("top",tooltip_top + "px")
        .style("left",w+"px");
        d3.select("#tooltip2")
        .style("z-index","3")
        .style("top",tooltip_top + "px")
        .style("left",w+"px");
        d3.select("#map_right")
        .style("z-index","2")
        .style("top",map_right_top+"px")
        .style("left",w+"px");
        d3.select("#under_map")
        .style("z-index","2")
        .style("top",h+"px");
	/*
        d3.select("#image_explanation")
        .style("top",color_top+"px");
	*/
        d3.select("#sample1")
	.style("opacity","0.5")
        .style("background-color",color_five);
        d3.select("#sample2")
	.style("opacity","0.5")
	.style("background-color",color_three);
        d3.select("#sample3")
	.style("opacity","0.5")
	.style("background-color",color_native);
        //Define default path generator

        //Create SVG element
        var svg = d3.select("#svg1")
        .attr("width", w)
        .attr("height", h)
        .append("g");
        /*
        .call(d3.behavior.zoom()
          .on("zoom", redraw));
          */
        function redraw() {
          svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + (d3.event.scale*1.5)+","+ (d3.event.scale) + ")");
        }
        //Load in GeoJSON data
        //var bounds = d3.geo.bounds(json);
        //23.978567
        var prj = d3.geo.mercator().center([121.279531, 24.378567]).scale(6000);
        var path = d3.geo.path().projection(prj);
        d3.json("./index_files/liyuan/newgeo.json",function(json){
          d3.csv("./index_files/liyuan/選票數.csv",function(data_vote){
            d3.csv("./index_files/liyuan/縣市應選人數.csv",function(data_people){
              for(var i = 0;i < data_vote.length; i++){
                var name = data_vote[i].縣市名;
                var number_of_vote = data_vote[i].選票數;

                for (var j=0;j<json.features.length;j++){
                    //alert(json.features[j].properties.town);
                    if(json.features[j].properties.name == name){
                      json.features[j].properties.number_of_vote = number_of_vote;
                      break;
                    }
                  }
                }
                for(var j=0;j<json.features.length;j++){
                  if(json.features[j].properties.town){
                    json.features[j].properties.number_of_vote = 5;
                  }
                }
                for(var i = 0;i<data_people.length;i++){

                  var name = data_people[i].縣市名;
                  var v1 = data_people[i].縣市長;
                  var v2 = data_people[i].縣市議員;
                  var v3 = data_people[i].鄉長;
                  var v4 = data_people[i].鄉民代表;
                  var v5 = data_people[i].村里長;
                  var v6 = data_people[i].合計;
                  var value = [v1, v2, v3, v4, v5, v6];
                  for(var j=0;j<json.features.length;j++){
                    if(json.features[j].properties.name == name){
                      json.features[j].properties.value = value;
                      break;
                    }
                  }
                }
		
                svg.selectAll("path")
                .data(json.features)
                .enter()
                .append("path")
                .attr("d",path)
		.style("opacity","0.5")
                //.attr("transform",transform_function)
                .style("fill",function(d){
        		if(d.properties.number_of_vote == 3){
          			return color_three;
        		}
        		else if(d.properties.town && islands.indexOf(d.properties.town) == -1){
          			return color_native;
        		}
        		else{
          			return color_five;
        		}
      		})
                .style("z-index","3");
		

  svg.selectAll("path")
  .attr("transform",transform_function)
  .each(function(d){
                          //alert("hihi");
                          var islands = ['澎湖縣','金門縣','連江縣','綠島鄉','蘭嶼鄉','琉球鄉'];
                          var name;
                          if(d.properties.name){
                            name = d.properties.name;
                          }
                          else if(d.properties.town){
                            name = d.properties.town;
                          }
                          else{
                            return 0;
                          }
                          //alert("wtf");
                          if(islands.indexOf(name) != -1){
                            create_boundary(d,d3.select(this).position(),name,this,json);
                          }
                          return 0;
                          //alert(d3.select(this).position().top);
                        });
        svg.attr("transform","scale(1.5,1)" );
	//svg.attr("transform","translate(121.579531,24.378567)"+"scale(1.5,1)" + "translate(-121.579531,-24.378567)");
		//.style("-webkit-transform","translate(122.579531,24.378567)"+"scale(1.5,1)" + "translate(-122.579531,-24.378567)");
	svg.selectAll("path")
		.on("mouseover",function(d){
                        mouseover(this,d,json);
                        var mouse = d3.mouse(svg.node()).map(function(d){ 
                                        return parseInt(d);
                        });
                        d3.select(this)
				.style("opacity","1.0");
                                //.style("fill","orange");
                })
        .on("mouseout",function(d){
                mouseout(svg);
                d3.select(this)
		.style("opacity","0.5")
                .style("fill",function(){
                if(d.properties.number_of_vote == 3){
                        return color_three;
                }
                else if(d.properties.town && islands.indexOf(d.properties.town) == -1){
                        return color_native;
                }
                else{
                        return color_five;
                }
                });
                if(d.properties.town){
                        d3.select("#tooltip2")
                        .style("display","None");
                }
                else{
                        d3.select("#tooltip1")
                        .style("display","None");
                }
        });
})
})
})
  </script>
  <div class="caption">
    <h2 style="margin:0px;
      color:#CB624F;
      text-align: center;
      padding-top: 30px;
      padding-bottom: 30px;
      font-size:30px;">台灣各地投票所位置查詢</h2>
    <form onSubmit="return codeAddress();" action="" role="form" class="form-inline" style="text-align:center;margin-bottom:30px">
      <input type="text" id="address" placeholder="請輸入你的戶籍地址" class="form-control"></input>
      <button style="background-color:#CB624F;border:0px;"type="submit" class="btn btn-success">送出</button>
      <div style="color:grey;font-size:12px;">註:因為中選會資料格式有誤，目前南投地區並無資料。</div>
    </form>
    <div id="map-canvas" style="height: 500px;margin: 0px;padding: 0px"></div>
    
  </div>
</div>		
</body>
</html>
